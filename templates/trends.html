{% extends "base.html" %}

{% block title %}Test Trends - {{ release }}/{{ module }}{% endblock %}

{% block content %}
<div x-data="trendsData('{{ release }}', '{{ module }}')" x-init="init()" class="trends-container">
    <!-- Header -->
    <div class="trends-header">
        <div class="breadcrumb">
            <a href="/">Dashboard</a> /
            <a :href="`/trends/${release}/${module}`" x-text="`${release}/${module}`"></a>
        </div>
        <h2>Test Trends</h2>
        <p class="subtitle">Analyze test behavior across multiple jobs</p>
    </div>

    <!-- Loading State -->
    <div x-show="loading" class="loading-spinner">
        <span class="spinner"></span>
        <span>Loading trends...</span>
    </div>

    <!-- Error State -->
    <div x-show="error" x-text="error" class="error-message"></div>

    <!-- Trends Content -->
    <div x-show="!loading && !error">
        <!-- Filters -->
        <div class="filters-section">
            <h3>Filters</h3>
            <div class="filter-chips">
                <button
                    @click="toggleFilter('failed')"
                    :class="{'active': filters.failed_only}"
                    class="filter-chip">
                    Failed Tests <span x-show="filters.failed_only">✓</span>
                </button>
                <!-- Visual separator between Failed Tests (AND) and other filters (OR) -->
                <span class="filter-divider" title="Failed Tests uses AND logic with other filters"></span>
                <button
                    @click="toggleFilter('flaky')"
                    :class="{'active': filters.flaky_only}"
                    class="filter-chip">
                    Flaky Tests <span x-show="filters.flaky_only">✓</span>
                </button>
                <button
                    @click="toggleFilter('regression')"
                    :class="{'active': filters.regression_only}"
                    class="filter-chip">
                    Regression <span x-show="filters.regression_only">✓</span>
                </button>
                <button
                    @click="toggleFilter('always_failing')"
                    :class="{'active': filters.always_failing_only}"
                    class="filter-chip">
                    Always Failing <span x-show="filters.always_failing_only">✓</span>
                </button>
                <button
                    @click="toggleFilter('new_failures')"
                    :class="{'active': filters.new_failures_only}"
                    class="filter-chip">
                    New Failures <span x-show="filters.new_failures_only">✓</span>
                </button>
            </div>

            <!-- Priority Filters -->
            <div class="filter-section">
                <label class="filter-label">Priority:</label>
                <div class="filter-chips priority-chips" role="group" aria-label="Filter by priority">
                    <button
                        @click="togglePriority('P0')"
                        :class="{'active': filters.priorities.includes('P0')}"
                        :aria-pressed="filters.priorities.includes('P0').toString()"
                        aria-label="Filter by P0 priority"
                        class="filter-chip priority-chip">
                        P0 <span x-show="filters.priorities.includes('P0')" aria-hidden="true">✓</span>
                    </button>
                    <button
                        @click="togglePriority('P1')"
                        :class="{'active': filters.priorities.includes('P1')}"
                        :aria-pressed="filters.priorities.includes('P1').toString()"
                        aria-label="Filter by P1 priority"
                        class="filter-chip priority-chip">
                        P1 <span x-show="filters.priorities.includes('P1')" aria-hidden="true">✓</span>
                    </button>
                    <button
                        @click="togglePriority('P2')"
                        :class="{'active': filters.priorities.includes('P2')}"
                        :aria-pressed="filters.priorities.includes('P2').toString()"
                        aria-label="Filter by P2 priority"
                        class="filter-chip priority-chip">
                        P2 <span x-show="filters.priorities.includes('P2')" aria-hidden="true">✓</span>
                    </button>
                    <button
                        @click="togglePriority('P3')"
                        :class="{'active': filters.priorities.includes('P3')}"
                        :aria-pressed="filters.priorities.includes('P3').toString()"
                        aria-label="Filter by P3 priority"
                        class="filter-chip priority-chip">
                        P3 <span x-show="filters.priorities.includes('P3')" aria-hidden="true">✓</span>
                    </button>
                    <button
                        @click="togglePriority('UNKNOWN')"
                        :class="{'active': filters.priorities.includes('UNKNOWN')}"
                        :aria-pressed="filters.priorities.includes('UNKNOWN').toString()"
                        aria-label="Filter by unknown priority"
                        class="filter-chip priority-chip">
                        Unknown <span x-show="filters.priorities.includes('UNKNOWN')" aria-hidden="true">✓</span>
                    </button>
                </div>
            </div>

            <!-- Job Display Limit -->
            <div class="filter-section">
                <label class="filter-label" for="job-display-limit">Display Jobs:</label>
                <select
                    x-model="jobDisplayLimit"
                    id="job-display-limit"
                    class="job-limit-dropdown"
                    aria-label="Select number of recent jobs to display">
                    <option :value="5">Last 5 Jobs</option>
                    <option :value="10">Last 10 Jobs</option>
                    <option :value="15">Last 15 Jobs</option>
                    <option :value="20">Last 20 Jobs</option>
                    <option value="all">All Jobs</option>
                </select>
            </div>

            <div class="filter-actions">
                <button
                    @click="clearFilters()"
                    x-show="hasActiveFilters()"
                    class="filter-chip clear">
                    Clear All Filters
                </button>
            </div>
            <div class="filter-stats">
                <span x-text="`Showing ${metadata?.total || 0} tests`"></span>
            </div>
        </div>

        <!-- Trends Table -->
        <div class="trends-table-container" x-show="trends.length > 0">
            <table class="trends-table">
                <thead>
                    <tr>
                        <th>Test Name</th>
                        <th>Priority</th>
                        <th>Latest Status</th>
                        <th title="Design topology from metadata CSV (test specification)">Design Topology</th>
                        <th>Behavior</th>
                        <th>Job Results</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="trend in trends" :key="trend.test_key">
                        <tr>
                            <td class="test-name-cell">
                                <a href="#" @click.prevent="viewDetails(trend.test_name)" class="test-name-link" x-text="trend.test_name"></a>
                            </td>
                            <td class="priority-cell">
                                <span :class="getPriorityBadgeClass(trend.priority)"
                                      x-text="getPriorityDisplayText(trend.priority)">
                                </span>
                            </td>
                            <td>
                                <span :class="getStatusClass(trend.latest_status)"
                                      x-text="trend.latest_status">
                                </span>
                            </td>
                            <td x-text="trend.topology_metadata || 'N/A'"></td>
                            <td>
                                <div class="behavior-badges">
                                    <span x-show="trend.is_flaky" class="badge badge-flaky">Flaky</span>
                                    <span x-show="trend.is_regression" class="badge badge-regression">Regression</span>
                                    <span x-show="trend.is_always_failing" class="badge badge-always-failing">Always Failing</span>
                                    <span x-show="trend.is_always_passing" class="badge badge-always-passing">Always Passing</span>
                                    <span x-show="trend.is_new_failure" class="badge badge-new-failure">New Failure</span>
                                </div>
                            </td>
                            <td>
                                <div class="job-results">
                                    <template x-for="(status, job_id) in getFilteredJobResults(trend)" :key="job_id">
                                        <a :href="`/jobs/${release}/${getJobModule(trend, job_id)}/${job_id}?test=${encodeURIComponent(trend.test_name)}`"
                                           :class="getJobResultClass(status)"
                                           :title="`Job ${job_id}: ${status} (Parent Job: ${getParentJobId(trend, job_id)}, Module: ${getJobModule(trend, job_id)})${getRerunInfo(trend, job_id)}`"
                                           class="job-result"
                                           x-text="getJobDisplayText(trend, job_id)">
                                        </a>
                                    </template>
                                </div>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>

            <!-- Pagination -->
            <div class="pagination" x-show="metadata?.total > 100">
                <button
                    @click="previousPage()"
                    :disabled="!metadata?.has_previous"
                    class="btn-pagination">
                    Previous
                </button>
                <span class="pagination-info">
                    Page <span x-text="getCurrentPage()"></span> of <span x-text="getTotalPages()"></span>
                </span>
                <button
                    @click="nextPage()"
                    :disabled="!metadata?.has_next"
                    class="btn-pagination">
                    Next
                </button>
            </div>
        </div>

        <!-- Empty State -->
        <div x-show="!trends.length && !loading" class="empty-state">
            <p>No trends found matching the current filters.</p>
        </div>
    </div>

    <!-- Execution History Modal -->
    <div x-show="showDetails"
         @click="closeDetails()"
         class="modal-overlay"
         role="dialog"
         aria-modal="true"
         aria-labelledby="modal-title">
        <div class="modal-content" @click.stop>
            <!-- Modal Header -->
            <div class="modal-header">
                <h3 id="modal-title">Execution History</h3>
                <button @click="closeDetails()"
                        class="modal-close"
                        aria-label="Close modal">&times;</button>
            </div>

            <!-- Test Details -->
            <div x-show="detailsData" class="modal-body">
                <div class="test-metadata">
                    <div class="metadata-row">
                        <span class="metadata-label">Test Name:</span>
                        <span class="metadata-value" x-text="detailsData?.testcase_name"></span>
                    </div>
                    <div class="metadata-row">
                        <span class="metadata-label">Test Case ID:</span>
                        <span class="metadata-value" x-text="detailsData?.test_case_id || 'N/A'"></span>
                    </div>
                    <div class="metadata-row">
                        <span class="metadata-label">TestRail ID:</span>
                        <span class="metadata-value" x-text="detailsData?.testrail_id || 'N/A'"></span>
                    </div>
                    <div class="metadata-row">
                        <span class="metadata-label">Priority:</span>
                        <span :class="getPriorityBadgeClass(detailsData?.priority)"
                              x-text="detailsData?.priority || 'Unknown'">
                        </span>
                    </div>
                    <div class="metadata-row">
                        <span class="metadata-label">Component:</span>
                        <span class="metadata-value" x-text="detailsData?.component || 'N/A'"></span>
                    </div>
                    <div class="metadata-row">
                        <span class="metadata-label">Class Name:</span>
                        <span class="metadata-value" x-text="detailsData?.test_class_name || 'N/A'"></span>
                    </div>
                    <div class="metadata-row">
                        <span class="metadata-label">Test Path:</span>
                        <span class="metadata-value" x-text="detailsData?.test_path || 'N/A'"></span>
                    </div>
                    <div class="metadata-row">
                        <span class="metadata-label">Test State:</span>
                        <span class="metadata-value" x-text="detailsData?.test_state || 'N/A'"></span>
                    </div>
                </div>

                <!-- Statistics -->
                <div x-show="detailsData?.statistics" class="statistics-section">
                    <h4>Statistics</h4>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <span class="stat-label">Total Runs:</span>
                            <span class="stat-value" x-text="detailsData?.statistics?.total_runs || 0"></span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Passed:</span>
                            <span class="stat-value status-passed" x-text="detailsData?.statistics?.passed || 0"></span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Failed:</span>
                            <span class="stat-value status-failed" x-text="detailsData?.statistics?.failed || 0"></span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Pass Rate:</span>
                            <span class="stat-value" x-text="(detailsData?.statistics?.pass_rate || 0) + '%'"></span>
                        </div>
                    </div>
                </div>

                <!-- Execution History -->
                <div x-show="detailsData?.execution_history" class="execution-history-section">
                    <h4>Recent Executions</h4>
                    <div class="execution-history-table-wrapper">
                        <table class="execution-history-table">
                            <thead>
                                <tr>
                                    <th>Job ID</th>
                                    <th>Release</th>
                                    <th>Module</th>
                                    <th>Version</th>
                                    <th>Status</th>
                                    <th title="Execution topology from JUnit XML (what Jenkins ran)">Jenkins Topology</th>
                                    <th title="Design topology from metadata CSV (test specification)">Design Topology</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="history in detailsData?.execution_history || []" :key="history.job_id + history.created_at">
                                    <tr>
                                        <td x-text="history.job_id"></td>
                                        <td x-text="history.release"></td>
                                        <td x-text="history.module"></td>
                                        <td x-text="history.version || 'N/A'"></td>
                                        <td>
                                            <span :class="getStatusClass(history.status)"
                                                  x-text="history.status">
                                            </span>
                                            <span x-show="history.was_rerun" class="rerun-badge">Rerun</span>
                                        </td>
                                        <td x-text="history.jenkins_topology || 'N/A'"></td>
                                        <td x-text="history.topology_metadata || 'N/A'"></td>
                                        <td x-text="formatDate(history.created_at)"></td>
                                        <td>
                                            <a :href="`/jobs/${history.release}/${history.module}/${history.job_id}?test=${encodeURIComponent(currentTestcaseName)}`"
                                               class="btn-small"
                                               target="_blank">
                                                View Job
                                            </a>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div x-show="detailsData?.pagination" class="pagination">
                        <button
                            @click="loadPreviousPage()"
                            :disabled="!hasPreviousPage()"
                            class="btn-pagination">
                            Previous
                        </button>
                        <span class="pagination-info">
                            Showing <span x-text="getPaginationStart()"></span> to <span x-text="getPaginationEnd()"></span>
                            of <span x-text="detailsData?.pagination?.total || 0"></span>
                        </span>
                        <button
                            @click="loadNextPage()"
                            :disabled="!hasNextPage()"
                            class="btn-pagination">
                            Next
                        </button>
                    </div>
                </div>
            </div>

            <!-- Loading State in Modal -->
            <div x-show="detailsLoading" class="loading-spinner" role="status" aria-live="polite">
                <p>Loading execution history...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/trends.js?v={{ range(1, 10000) | random }}"></script>
{% endblock %}
