{% extends "base.html" %}

{% block title %}Admin - Regression Tracker{% endblock %}

{% block content %}
<div x-data="adminData()" x-init="init()" class="admin-container">
    <!-- PIN Authentication Modal -->
    <div x-show="showPinModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3>Admin Authentication</h3>
            <p>Please enter the admin PIN to access admin settings.</p>

            <div class="form-group">
                <label>Admin PIN:</label>
                <input
                    type="password"
                    x-model="pinInput"
                    @keyup.enter="submitPin()"
                    placeholder="Enter PIN"
                    class="form-input"
                    autofocus>
            </div>

            <div x-show="pinError" x-text="pinError" class="error-message" style="display: none;"></div>

            <div class="form-actions">
                <button @click="submitPin()" class="btn-primary">
                    Submit
                </button>
                <button @click="cancelPin()" class="btn-secondary">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Metadata Sync Details Modal -->
    <div x-show="metadataSync.showDetailsModal"
         class="modal-overlay"
         style="display: none;"
         @click.self="metadataSync.showDetailsModal = false">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3>Metadata Sync Changes</h3>
                <button @click="metadataSync.showDetailsModal = false" class="modal-close">&times;</button>
            </div>

            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <div x-show="metadataSync.detailsLoading" class="loading-spinner">
                    <p>Loading sync details...</p>
                </div>

                <div x-show="!metadataSync.detailsLoading" x-html="metadataSync.detailsHtml"></div>
            </div>

            <div class="modal-footer">
                <button @click="metadataSync.showDetailsModal = false" class="btn-secondary">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <div class="admin-header">
        <h2>Admin Settings</h2>
        <p class="subtitle">Manage application settings, Jenkins polling, and releases</p>
    </div>

    <!-- Loading State -->
    <div x-show="loading" class="loading-spinner">
        <p>Loading settings...</p>
    </div>

    <!-- Error State -->
    <div x-show="error" x-text="error" class="error-message"></div>

    <!-- Admin Content -->
    <div x-show="!loading && !error">
        <!-- Jenkins Polling Section -->
        <div class="admin-section">
            <div class="section-header">
                <h3>Jenkins Polling</h3>
            </div>

            <div class="card">
                <!-- Polling Status -->
                <div class="polling-status">
                    <div class="status-row">
                        <span class="status-label">Status:</span>
                        <span class="badge" :class="pollingStatus.enabled ? 'badge-active' : 'badge-inactive'">
                            <span x-text="pollingStatus.enabled ? 'Enabled' : 'Disabled'"></span>
                        </span>
                    </div>

                    <div class="status-row" x-show="pollingStatus.enabled && pollingStatus.scheduler.next_run">
                        <span class="status-label">Next Run:</span>
                        <span x-text="formatDate(pollingStatus.scheduler.next_run)"></span>
                    </div>

                    <div class="status-row">
                        <span class="status-label">Interval:</span>
                        <span x-text="formatInterval(pollingStatus.interval_hours)"></span>
                    </div>
                </div>

                <!-- Polling Controls -->
                <div class="polling-controls">
                    <button
                        @click="togglePolling()"
                        class="btn-secondary"
                        :disabled="updatingPolling"
                        x-text="pollingStatus.enabled ? 'Disable Polling' : 'Enable Polling'">
                    </button>

                    <input
                        type="number"
                        x-model="newIntervalHours"
                        min="0.25"
                        max="168"
                        step="0.25"
                        placeholder="Interval (hours)"
                        class="interval-input">

                    <button
                        @click="updateInterval()"
                        class="btn-small"
                        :disabled="updatingPolling">
                        Update Interval
                    </button>
                </div>
            </div>
        </div>

        <!-- Manual Download Section -->
        <div class="admin-section">
            <div class="section-header">
                <h3>Manual Jenkins Download</h3>
            </div>

            <div class="card">
                <div class="download-form">
                    <div class="form-group">
                        <label>Release (optional):</label>
                        <input
                            type="text"
                            x-model="downloadForm.release"
                            placeholder="e.g., 6.4 (auto-extracted from URL if empty)"
                            class="form-input">
                        <small class="text-muted">If empty, will be extracted from URL pattern: .../QA_Release_X.X/...</small>
                    </div>

                    <div class="form-group">
                        <label>Jenkins Job URL:</label>
                        <input
                            type="text"
                            x-model="downloadForm.job_url"
                            placeholder="https://jenkins.../job/QA_Release_6.4/job/.../216/"
                            class="form-input">
                    </div>

                    <div class="form-group">
                        <label>
                            <input
                                type="checkbox"
                                x-model="downloadForm.skip_existing">
                            Skip Existing Files
                        </label>
                    </div>

                    <button
                        @click="startDownload()"
                        class="btn-secondary"
                        :disabled="downloadInProgress">
                        <span x-show="!downloadInProgress">Start Download</span>
                        <span x-show="downloadInProgress">Downloading...</span>
                    </button>
                </div>

                <!-- Download Progress -->
                <div x-show="downloadJobId" class="download-progress">
                    <h4>Download Progress</h4>
                    <div class="log-output">
                        <template x-for="log in downloadLogs" :key="log.timestamp">
                            <div class="log-line" x-text="log.message"></div>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <!-- On-Demand Polling Section -->
        <div class="admin-section">
            <div class="section-header">
                <h3>On-Demand Polling</h3>
                <p class="text-muted">Check for and download new builds from active releases</p>
            </div>

            <div class="card">
                <!-- Discovery Controls -->
                <div class="discovery-controls">
                    <button
                        @click="discoverJobs()"
                        class="btn-primary"
                        :disabled="discovering">
                        <span x-show="!discovering">Check for New Builds</span>
                        <span x-show="discovering">
                            <span class="spinner"></span> Discovering...
                        </span>
                    </button>
                    <span x-show="discoveredJobs.length > 0" class="discovery-summary">
                        Found <strong x-text="discoveredJobs.length"></strong> new builds
                    </span>
                </div>

                <!-- Job Selection Table (shown when jobs discovered) -->
                <div x-show="discoveredJobs.length > 0" class="job-selection">
                    <div class="selection-controls">
                        <label class="checkbox-label">
                            <input
                                type="checkbox"
                                @change="toggleSelectAll()"
                                :checked="allSelected">
                            Select All
                        </label>
                        <button
                            @click="downloadSelected()"
                            class="btn-success"
                            :disabled="selectedJobs.length === 0 || downloadInProgress">
                            Download Selected (<span x-text="selectedJobs.length"></span>)
                        </button>
                    </div>

                    <!-- Jobs Grouped by Release -->
                    <template x-for="(releaseJobs, releaseName) in jobsByRelease" :key="releaseName">
                        <div class="release-group">
                            <h4 class="release-name" x-text="releaseName"></h4>
                            <table class="jobs-table">
                                <thead>
                                    <tr>
                                        <th width="50px">Select</th>
                                        <th>Build Number</th>
                                        <th>Jenkins URL</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="job in releaseJobs" :key="job.key">
                                        <tr>
                                            <td>
                                                <input
                                                    type="checkbox"
                                                    :value="job.key"
                                                    x-model="selectedJobs">
                                            </td>
                                            <td>
                                                <strong x-text="'#' + job.build_number"></strong>
                                            </td>
                                            <td>
                                                <a :href="job.build_url"
                                                   target="_blank"
                                                   class="btn-sm btn-link">View Build</a>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </template>
                </div>

                <!-- No Builds Message -->
                <div x-show="!discovering && discoveredJobs.length === 0 && discoveryComplete"
                     class="alert alert-info">
                    No new builds found. All active releases are up to date.
                </div>

                <!-- Download Progress -->
                <div x-show="downloadJobId" class="download-progress">
                    <h4>Download Progress</h4>
                    <div class="log-output">
                        <template x-for="log in downloadLogs" :key="log.timestamp">
                            <div class="log-line" x-text="log.message"></div>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <!-- Release Management Section -->
        <div class="admin-section">
            <div class="section-header">
                <h3>Release Management</h3>
                <button @click="showAddReleaseForm = true" class="btn-small">
                    + Add Release
                </button>
            </div>

            <!-- Add Release Form -->
            <div x-show="showAddReleaseForm" class="card add-release-form">
                <h4>Add New Release</h4>
                <div class="form-group">
                    <label>Release Name:</label>
                    <input
                        type="text"
                        x-model="newRelease.name"
                        placeholder="e.g., 7.0.0.0"
                        class="form-input">
                </div>

                <div class="form-group">
                    <label>Jenkins Job URL:</label>
                    <input
                        type="text"
                        x-model="newRelease.jenkins_job_url"
                        placeholder="https://jenkins.../job/..."
                        class="form-input">
                </div>

                <div class="form-group">
                    <label>
                        <input
                            type="checkbox"
                            x-model="newRelease.is_active">
                        Active
                    </label>
                </div>

                <div class="form-actions">
                    <button @click="addRelease()" class="btn-secondary">
                        Create Release
                    </button>
                    <button @click="showAddReleaseForm = false; resetNewRelease()" class="btn-small">
                        Cancel
                    </button>
                </div>
            </div>

            <!-- Releases Table -->
            <div class="card">
                <table class="releases-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Git Branch</th>
                            <th>Jenkins URL</th>
                            <th>Status</th>
                            <th>Modules</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="release in releases" :key="release.id">
                            <tr>
                                <td x-text="release.name"></td>
                                <td>
                                    <!-- Inline Git Branch Edit -->
                                    <div class="git-branch-edit">
                                        <input
                                            type="text"
                                            :value="release.git_branch || ''"
                                            @blur="updateGitBranch(release, $event.target.value)"
                                            @keyup.enter="$event.target.blur()"
                                            placeholder="e.g., master, release_6.4"
                                            class="form-input-small"
                                            style="min-width: 150px;">
                                        <small class="text-muted" x-show="!release.git_branch">
                                            Not configured
                                        </small>
                                    </div>
                                </td>
                                <td>
                                    <a :href="release.jenkins_job_url"
                                       target="_blank"
                                       x-show="release.jenkins_job_url"
                                       class="jenkins-link">
                                        View Job
                                    </a>
                                    <span x-show="!release.jenkins_job_url" class="text-muted">
                                        Not configured
                                    </span>
                                </td>
                                <td>
                                    <span class="badge" :class="release.is_active ? 'badge-active' : 'badge-inactive'">
                                        <span x-text="release.is_active ? 'Active' : 'Inactive'"></span>
                                    </span>
                                </td>
                                <td x-text="release.module_count"></td>
                                <td x-text="formatDate(release.created_at)"></td>
                                <td>
                                    <button
                                        @click="toggleReleaseActive(release)"
                                        class="btn-small">
                                        <span x-text="release.is_active ? 'Deactivate' : 'Activate'"></span>
                                    </button>
                                    <button
                                        @click="deleteRelease(release)"
                                        class="btn-small btn-danger"
                                        :disabled="release.is_active">
                                        Delete
                                    </button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Database Maintenance Section -->
        <div class="admin-section">
            <div class="section-header">
                <h3>Database Maintenance</h3>
            </div>

            <div class="card">
                <div class="maintenance-section">
                    <div class="maintenance-header">
                        <h4>Sync Last Processed Builds</h4>
                        <p class="text-muted">
                            Synchronize the last_processed_build field with actual max builds in database.
                            Useful after manual imports or data migrations.
                        </p>
                    </div>

                    <div class="maintenance-controls">
                        <button
                            @click="syncLastProcessedBuilds()"
                            class="btn-secondary"
                            :disabled="syncingBuilds">
                            <span x-show="!syncingBuilds">Sync Last Processed Builds</span>
                            <span x-show="syncingBuilds">
                                <span class="spinner"></span> Syncing...
                            </span>
                        </button>
                    </div>

                    <!-- Sync Results -->
                    <div x-show="syncResults" class="sync-results">
                        <h5>Sync Results</h5>
                        <div class="alert" :class="syncResults && syncResults.error ? 'alert-danger' : (syncResults && syncResults.updates_made > 0 ? 'alert-success' : 'alert-info')">
                            <p x-text="syncResults ? syncResults.message : ''"></p>
                            <p class="text-sm" x-show="!syncResults || !syncResults.error">
                                <strong>Releases processed:</strong> <span x-text="syncResults ? syncResults.releases_processed : 0"></span> |
                                <strong>Updates made:</strong> <span x-text="syncResults ? syncResults.updates_made : 0"></span>
                            </p>
                        </div>

                        <table class="sync-results-table" x-show="syncResults && syncResults.results">
                            <thead>
                                <tr>
                                    <th>Release</th>
                                    <th>Old Value</th>
                                    <th>New Value</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="result in (syncResults ? syncResults.results : [])" :key="result.release_name">
                                    <tr>
                                        <td x-text="result.release_name"></td>
                                        <td x-text="result.old_value"></td>
                                        <td x-text="result.new_value"></td>
                                        <td>
                                            <span class="badge" :class="result.updated ? 'badge-success' : 'badge-secondary'">
                                                <span x-text="result.updated ? 'Updated' : 'No Change'"></span>
                                            </span>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bug Tracking Section -->
        <div class="admin-section">
            <div class="section-header">
                <h3>Bug Tracking (VLEI/VLENG)</h3>
                <p class="text-muted">Manage bug associations from Jira</p>
            </div>

            <div class="card">
                <div class="bug-stats">
                    <div class="status-row">
                        <span class="status-label">Last Updated:</span>
                        <span class="status-value" x-text="formatBugLastUpdate(bugTracking.lastUpdate)"></span>
                    </div>
                    <div class="status-row">
                        <span class="status-label">Total Bugs:</span>
                        <span class="status-value" x-text="bugTracking.totalBugs"></span>
                    </div>
                    <div class="status-row">
                        <span class="status-label">VLEI Bugs:</span>
                        <span class="status-value" x-text="bugTracking.vleiBugs"></span>
                    </div>
                    <div class="status-row">
                        <span class="status-label">VLENG Bugs:</span>
                        <span class="status-value" x-text="bugTracking.vlengBugs"></span>
                    </div>
                </div>

                <button @click="updateBugs()"
                        :disabled="bugTracking.updating"
                        class="btn-primary"
                        style="margin-top: 1rem;">
                    <span x-show="!bugTracking.updating">üîÑ Update Bugs Now</span>
                    <span x-show="bugTracking.updating">‚è≥ Updating...</span>
                </button>

                <div x-show="bugTracking.updateMessage"
                     class="alert"
                     :class="bugTracking.updateSuccess ? 'alert-success' : 'alert-error'"
                     x-text="bugTracking.updateMessage"
                     style="margin-top: 1rem;">
                </div>
            </div>
        </div>

        <!-- Metadata Sync Section -->
        <div class="admin-section">
            <div class="section-header">
                <h3>üîÑ Metadata Sync (Git)</h3>
                <p class="text-muted">Sync test metadata from Git repository (pytest markers)</p>
            </div>

            <div class="card">
                <!-- Sync Status -->
                <div class="polling-status">
                    <div class="status-row">
                        <span class="status-label">Scheduled Sync:</span>
                        <span class="badge" :class="metadataSync.enabled ? 'badge-active' : 'badge-inactive'">
                            <span x-text="metadataSync.enabled ? 'Enabled' : 'Disabled'"></span>
                        </span>
                    </div>

                    <div class="status-row" x-show="metadataSync.enabled && metadataSync.nextRun">
                        <span class="status-label">Next Run:</span>
                        <span x-text="formatDate(metadataSync.nextRun)"></span>
                    </div>

                    <div class="status-row">
                        <span class="status-label">Interval:</span>
                        <span x-text="formatInterval(metadataSync.intervalHours)"></span>
                    </div>

                    <div class="status-row" x-show="metadataSync.lastSync">
                        <span class="status-label">Last Sync:</span>
                        <span>
                            <span x-text="formatDate(metadataSync.lastSync?.started_at)"></span>
                            <span class="badge badge-sm"
                                  :class="metadataSync.lastSync?.status === 'success' ? 'badge-success' : 'badge-error'"
                                  x-text="metadataSync.lastSync?.status"></span>
                        </span>
                    </div>

                    <div class="status-row" x-show="metadataSync.lastSync">
                        <span class="status-label">Git Commit:</span>
                        <code x-text="(metadataSync.lastSync?.git_commit || 'N/A').substring(0, 7)"></code>
                    </div>

                    <div class="status-row" x-show="metadataSync.lastSync">
                        <span class="status-label">Tests:</span>
                        <span>
                            <span x-text="metadataSync.lastSync?.tests_discovered || 0"></span> discovered,
                            <span class="text-success" x-text="metadataSync.lastSync?.tests_added || 0"></span> added,
                            <span class="text-info" x-text="metadataSync.lastSync?.tests_updated || 0"></span> updated,
                            <span class="text-warning" x-text="metadataSync.lastSync?.tests_removed || 0"></span> removed
                        </span>
                    </div>
                </div>

                <!-- Release Selector -->
                <div class="form-group" style="margin-top: 1rem;">
                    <label>Sync for Release:</label>
                    <select x-model="metadataSync.selectedRelease" class="form-input" style="max-width: 300px;">
                        <option value="">All Releases (Global)</option>
                        <template x-for="release in releases" :key="release.id">
                            <option :value="release.id" x-text="`${release.name} (${release.git_branch || 'No branch configured'})`"></option>
                        </template>
                    </select>
                    <small class="text-muted">
                        Select a release to sync metadata from its configured Git branch, or leave as "All Releases" for global sync
                    </small>
                </div>

                <!-- Sync Controls -->
                <div class="polling-controls" style="margin-top: 1rem;">
                    <button @click="triggerMetadataSync()"
                            :disabled="metadataSync.syncing"
                            class="btn-primary">
                        <span x-show="!metadataSync.syncing">üîÑ Sync Now</span>
                        <span x-show="metadataSync.syncing">‚è≥ Syncing...</span>
                    </button>

                    <button @click="toggleMetadataSync()"
                            class="btn-secondary"
                            :disabled="metadataSync.updating">
                        <span x-text="metadataSync.enabled ? 'Disable Scheduled Sync' : 'Enable Scheduled Sync'"></span>
                    </button>

                    <button @click="showMetadataSyncHistory()"
                            class="btn-small">
                        üìä View History
                    </button>

                    <button @click="viewSyncChanges()"
                            class="btn-small"
                            x-show="metadataSync.lastSync"
                            :disabled="!metadataSync.lastSync">
                        üìù View Details
                    </button>
                </div>

                <div x-show="metadataSync.message"
                     class="alert"
                     :class="metadataSync.messageSuccess ? 'alert-success' : 'alert-error'"
                     x-text="metadataSync.message"
                     style="margin-top: 1rem;">
                </div>
            </div>
        </div>

        <!-- App Settings Section -->
        <div class="admin-section">
            <div class="section-header">
                <h3>Application Settings</h3>
            </div>

            <div class="card">
                <table class="settings-table">
                    <thead>
                        <tr>
                            <th>Key</th>
                            <th>Value</th>
                            <th>Description</th>
                            <th>Last Updated</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="setting in settings" :key="setting.key">
                            <tr>
                                <td x-text="setting.key"></td>
                                <td>
                                    <code x-text="setting.value"></code>
                                </td>
                                <td x-text="setting.description"></td>
                                <td x-text="formatDate(setting.updated_at)"></td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/admin.js"></script>
{% endblock %}
