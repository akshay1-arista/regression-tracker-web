{% extends "base.html" %}

{% block title %}Dashboard - Regression Tracker{% endblock %}

{% block extra_head %}
<!-- Chart.js - Only needed for dashboard -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
{% endblock %}

{% block content %}
<div x-data="dashboardData()" x-init="init()" class="dashboard-container">
    <!-- Loading State -->
    <div x-show="loading" class="loading-spinner">
        <p>Loading dashboard...</p>
    </div>

    <!-- Error State -->
    <div x-show="error" x-text="error" class="error-message"></div>

    <!-- Dashboard Content -->
    <div x-show="!loading && !error">
        <!-- Header with Selectors -->
        <div class="dashboard-header">
            <h2>Test Results Dashboard</h2>
            <div class="selectors">
                <!-- Release Selector -->
                <div class="selector-group">
                    <label for="release-select">Release:</label>
                    <select
                        id="release-select"
                        x-model="selectedRelease"
                        @change="loadVersions()"
                        class="selector">
                        <template x-for="release in releases" :key="release.name">
                            <option :value="release.name" x-text="release.name"></option>
                        </template>
                    </select>
                </div>

                <!-- Version Selector -->
                <div class="selector-group">
                    <label for="version-select">Version:</label>
                    <select
                        id="version-select"
                        x-model="selectedVersion"
                        @change="loadModules()"
                        class="selector"
                        :disabled="!versions.length">
                        <option value="">All Versions</option>
                        <template x-for="version in versions" :key="version">
                            <option :value="version" x-text="version"></option>
                        </template>
                    </select>
                </div>

                <!-- Module Selector -->
                <div class="selector-group">
                    <label for="module-select">Module:</label>
                    <select
                        id="module-select"
                        x-model="selectedModule"
                        @change="loadSummary()"
                        class="selector"
                        :disabled="!modules.length">
                        <template x-for="module in modules" :key="module.name">
                            <option :value="module.name" x-text="module.name === '__all__' ? 'All Modules' : module.name"></option>
                        </template>
                    </select>
                </div>

                <!-- Auto-refresh Toggle -->
                <div class="selector-group">
                    <label>
                        <input type="checkbox" x-model="autoRefresh" @change="toggleAutoRefresh()">
                        Auto-refresh (60s)
                    </label>
                </div>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="summary-cards" x-show="summary">
            <div class="card">
                <h3 x-text="selectedModule === '__all__' ? 'Latest Run' : 'Latest Job'"></h3>
                <div class="stat-value" x-text="selectedModule === '__all__' ? (summary?.latest_run?.parent_job_id || 'N/A') : (summary?.latest_job?.job_id || 'N/A')"></div>
                <div class="stat-label" x-text="selectedModule === '__all__' ? 'Run ID' : 'Job ID'"></div>
            </div>

            <div class="card">
                <h3>Total Tests</h3>
                <div class="stat-value" x-text="summary?.total_tests || 0"></div>
                <div class="stat-label" x-text="selectedModule === '__all__' ? 'in latest run' : 'in latest job'"></div>
            </div>

            <div class="card">
                <h3>Pass Rate</h3>
                <div class="stat-value"
                     :class="getPassRateClass(selectedModule === '__all__' ? summary?.latest_run?.pass_rate : summary?.latest_job?.pass_rate)"
                     x-text="(selectedModule === '__all__' ? (summary?.latest_run?.pass_rate || 0) : (summary?.latest_job?.pass_rate || 0)) + '%'">
                </div>
                <div class="stat-label">Average: <span x-text="(summary?.average_pass_rate || 0) + '%'"></span></div>
            </div>

            <div class="card">
                <h3 x-text="selectedModule === '__all__' ? 'Total Runs' : 'Total Jobs'"></h3>
                <div class="stat-value" x-text="selectedModule === '__all__' ? (summary?.total_runs || 0) : (summary?.total_jobs || 0)"></div>
                <div class="stat-label">tracked</div>
            </div>

            <!-- Module Count Card (All Modules view only) -->
            <div class="card" x-show="selectedModule === '__all__'">
                <h3>Modules</h3>
                <div class="stat-value" x-text="summary?.latest_run?.module_count || 0"></div>
                <div class="stat-label">in latest run</div>
            </div>
        </div>

        <!-- Priority Statistics Card -->
        <div class="priority-stats-section" x-show="priorityStats.length > 0">
            <div class="priority-stats-header">
                <h3>Test Results by Priority (Latest Job)</h3>
                <a
                    x-show="selectedModule !== '__all__'"
                    :href="`/trends/${selectedRelease}/${selectedModule}`"
                    class="btn-secondary">
                    View Trends
                </a>
            </div>
            <table class="priority-stats-table">
                <thead>
                    <tr>
                        <th>Priority</th>
                        <th>Total</th>
                        <th>Passed</th>
                        <th>Failed</th>
                        <th>Skipped</th>
                        <th>Pass Rate</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="stat in priorityStats" :key="stat.priority">
                        <tr>
                            <!-- Priority Badge -->
                            <td>
                                <span :class="getPriorityBadgeClass(stat.priority)"
                                      x-text="stat.priority">
                                </span>
                            </td>

                            <!-- Total with comparison -->
                            <td>
                                <span x-text="stat.total"></span>
                                <span
                                    x-show="stat.comparison && stat.comparison.total_delta !== 0"
                                    :class="getComparisonClass(stat.comparison?.total_delta, 'total')"
                                    :title="getComparisonTooltip(stat, 'total')"
                                    class="comparison-indicator"
                                    x-text="getComparisonIndicator(stat.comparison?.total_delta, 'total')">
                                </span>
                            </td>

                            <!-- Passed with comparison -->
                            <td class="status-passed">
                                <span x-text="stat.passed"></span>
                                <span
                                    x-show="stat.comparison && stat.comparison.passed_delta !== 0"
                                    :class="getComparisonClass(stat.comparison?.passed_delta, 'passed')"
                                    :title="getComparisonTooltip(stat, 'passed')"
                                    class="comparison-indicator"
                                    x-text="getComparisonIndicator(stat.comparison?.passed_delta, 'passed')">
                                </span>
                            </td>

                            <!-- Failed with comparison -->
                            <td class="status-failed">
                                <span x-text="stat.failed"></span>
                                <span
                                    x-show="stat.comparison && stat.comparison.failed_delta !== 0"
                                    :class="getComparisonClass(stat.comparison?.failed_delta, 'failed')"
                                    :title="getComparisonTooltip(stat, 'failed')"
                                    class="comparison-indicator"
                                    x-text="getComparisonIndicator(stat.comparison?.failed_delta, 'failed')">
                                </span>
                            </td>

                            <!-- Skipped with comparison -->
                            <td class="status-skipped">
                                <span x-text="stat.skipped"></span>
                                <span
                                    x-show="stat.comparison && stat.comparison.skipped_delta !== 0"
                                    :class="getComparisonClass(stat.comparison?.skipped_delta, 'skipped')"
                                    :title="getComparisonTooltip(stat, 'skipped')"
                                    class="comparison-indicator"
                                    x-text="getComparisonIndicator(stat.comparison?.skipped_delta, 'skipped')">
                                </span>
                            </td>

                            <!-- Pass Rate with comparison -->
                            <td>
                                <span :class="getPassRateClass(stat.pass_rate)"
                                      x-text="stat.pass_rate + '%'">
                                </span>
                                <span
                                    x-show="stat.comparison && stat.comparison.pass_rate_delta !== 0"
                                    :class="getComparisonClass(stat.comparison?.pass_rate_delta, 'pass_rate')"
                                    :title="getComparisonTooltip(stat, 'pass_rate')"
                                    class="comparison-indicator"
                                    x-text="getComparisonIndicator(stat.comparison?.pass_rate_delta, 'pass_rate')">
                                </span>
                            </td>
                        </tr>
                    </template>
                </tbody>
                <tfoot>
                    <tr>
                        <td><strong>Total</strong></td>

                        <!-- Total with comparison -->
                        <td>
                            <strong x-text="getPriorityStatsTotal('total')"></strong>
                            <span
                                x-show="hasTotalComparison() && getPriorityStatsTotalDelta('total') !== 0"
                                :class="getComparisonClass(getPriorityStatsTotalDelta('total'), 'total')"
                                class="comparison-indicator"
                                x-text="getComparisonIndicator(getPriorityStatsTotalDelta('total'), 'total')">
                            </span>
                        </td>

                        <!-- Passed with comparison -->
                        <td class="status-passed">
                            <strong x-text="getPriorityStatsTotal('passed')"></strong>
                            <span
                                x-show="hasTotalComparison() && getPriorityStatsTotalDelta('passed') !== 0"
                                :class="getComparisonClass(getPriorityStatsTotalDelta('passed'), 'passed')"
                                class="comparison-indicator"
                                x-text="getComparisonIndicator(getPriorityStatsTotalDelta('passed'), 'passed')">
                            </span>
                        </td>

                        <!-- Failed with comparison -->
                        <td class="status-failed">
                            <strong x-text="getPriorityStatsTotal('failed')"></strong>
                            <span
                                x-show="hasTotalComparison() && getPriorityStatsTotalDelta('failed') !== 0"
                                :class="getComparisonClass(getPriorityStatsTotalDelta('failed'), 'failed')"
                                class="comparison-indicator"
                                x-text="getComparisonIndicator(getPriorityStatsTotalDelta('failed'), 'failed')">
                            </span>
                        </td>

                        <!-- Skipped with comparison -->
                        <td class="status-skipped">
                            <strong x-text="getPriorityStatsTotal('skipped')"></strong>
                            <span
                                x-show="hasTotalComparison() && getPriorityStatsTotalDelta('skipped') !== 0"
                                :class="getComparisonClass(getPriorityStatsTotalDelta('skipped'), 'skipped')"
                                class="comparison-indicator"
                                x-text="getComparisonIndicator(getPriorityStatsTotalDelta('skipped'), 'skipped')">
                            </span>
                        </td>

                        <!-- Pass Rate with comparison -->
                        <td>
                            <strong :class="getPassRateClass(getPriorityStatsOverallPassRate())"
                                    x-text="getPriorityStatsOverallPassRate() + '%'">
                            </strong>
                            <span
                                x-show="hasTotalComparison() && getPriorityStatsTotalDelta('pass_rate') !== 0"
                                :class="getComparisonClass(getPriorityStatsTotalDelta('pass_rate'), 'pass_rate')"
                                class="comparison-indicator"
                                x-text="getComparisonIndicator(getPriorityStatsTotalDelta('pass_rate'), 'pass_rate')">
                            </span>
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <!-- Priority Statistics Error Warning -->
        <div x-show="priorityStatsError && priorityStats.length === 0 && summary" class="warning-message" style="margin-bottom: var(--spacing-lg);">
            ⚠️ Priority statistics are temporarily unavailable
        </div>

        <!-- Flaky Tests by Priority (Compact Horizontal Table) -->
        <div class="priority-stats-section flaky-stats-compact" x-show="summary && summary.total_passed_flaky > 0">
            <div class="priority-stats-header">
                <h3>
                    Flaky Tests by Priority
                    <span class="info-tooltip" title="Shows flaky tests that passed in the current job (based on last 5 jobs)">ⓘ</span>
                </h3>
            </div>
            <table class="priority-stats-table flaky-horizontal-table">
                <thead>
                    <tr>
                        <th></th>
                        <th class="priority-p0">P0</th>
                        <th class="priority-p1">P1</th>
                        <th class="priority-p2">P2</th>
                        <th class="priority-p3">P3</th>
                        <th class="priority-unknown">UNKNOWN</th>
                        <th class="priority-total">Total</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="row-header"><strong>Flaky</strong></td>
                        <td class="status-flaky" x-text="getFlakyCount('P0')"></td>
                        <td class="status-flaky" x-text="getFlakyCount('P1')"></td>
                        <td class="status-flaky" x-text="getFlakyCount('P2')"></td>
                        <td class="status-flaky" x-text="getFlakyCount('P3')"></td>
                        <td class="status-flaky" x-text="getFlakyCount('UNKNOWN')"></td>
                        <td class="status-flaky"><strong x-text="summary?.total_passed_flaky || 0"></strong></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Pass Rate Chart -->
        <div class="chart-container" x-show="passRateHistory.length > 0">
            <div class="chart-header">
                <h3 x-text="excludeFlaky ? 'Pass Rate History (Excluding Flaky Tests)' : 'Pass Rate History'"></h3>
                <!-- Exclude Flaky Checkbox -->
                <label class="exclude-flaky-checkbox-inline" x-show="summary && summary.total_flaky > 0">
                    <input
                        type="checkbox"
                        x-model="excludeFlaky"
                        @change="toggleExcludeFlaky()">
                    <span>Exclude flaky</span>
                </label>
            </div>
            <canvas id="passRateChart"></canvas>
        </div>

        <!-- Recent Jobs Table (Single Module view only) -->
        <div class="jobs-section" x-show="selectedModule !== '__all__' && recentJobs.length > 0">
            <div class="section-header">
                <h3>Recent Jobs</h3>
                <a :href="`/trends/${selectedRelease}/${selectedModule}`" class="btn-secondary">
                    View Trends
                </a>
            </div>
            <table class="jobs-table">
                <thead>
                    <tr>
                        <th>Job ID</th>
                        <th>Version</th>
                        <th>Total Tests</th>
                        <th>Passed</th>
                        <th>Failed</th>
                        <th>Skipped</th>
                        <th>Pass Rate</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="job in recentJobs" :key="job.job_id || job.parent_job_id">
                        <tr>
                            <td>
                                <a :href="`/jobs/${selectedRelease}/${selectedModule}/${job.job_id}`"
                                   class="job-link"
                                   x-text="job.job_id">
                                </a>
                            </td>
                            <td x-text="job.version || 'N/A'"></td>
                            <td x-text="job.total"></td>
                            <td class="status-passed" x-text="job.passed"></td>
                            <td class="status-failed" x-text="job.failed"></td>
                            <td class="status-skipped" x-text="job.skipped"></td>
                            <td>
                                <span :class="getPassRateClass(job.pass_rate)"
                                      x-text="job.pass_rate + '%'">
                                </span>
                            </td>
                            <td x-text="formatDate(job.created_at)"></td>
                            <td>
                                <a :href="`/jobs/${selectedRelease}/${selectedModule}/${job.job_id}`"
                                   class="btn-small">
                                    Details
                                </a>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>

        <!-- Module Breakdown Table (All Modules view only) -->
        <div class="module-breakdown-section" x-show="selectedModule === '__all__' && moduleBreakdown.length > 0">
            <div class="section-header">
                <h3>Module Statistics (Latest Run)</h3>
            </div>

            <!-- Priority Filter -->
            <div class="priority-filter-container">
                <div class="filter-label">Filter by Priority:</div>
                <div class="priority-checkboxes">
                    <template x-for="priority in availablePriorities" :key="priority">
                        <label class="priority-checkbox-label">
                            <input type="checkbox"
                                   :value="priority"
                                   x-model="selectedPriorities"
                                   @change="loadSummary()">
                            <span x-text="priority"></span>
                        </label>
                    </template>
                </div>
                <button class="btn-clear-filter"
                        x-show="selectedPriorities.length > 0"
                        @click="selectedPriorities = []; loadSummary();">
                    Clear Filters
                </button>
            </div>

            <table class="module-breakdown-table">
                <thead>
                    <tr>
                        <th>Module</th>
                        <th>Total Tests</th>
                        <th>Passed</th>
                        <th>Failed</th>
                        <th>Skipped</th>
                        <th>Pass Rate</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="module in moduleBreakdown" :key="module.module_name">
                        <tr>
                            <td>
                                <a :href="`/trends/${selectedRelease}/${module.module_name}`"
                                   class="module-link"
                                   x-text="module.module_name">
                                </a>
                            </td>
                            <td x-text="module.total"></td>
                            <td class="status-passed" x-text="module.passed"></td>
                            <td class="status-failed" x-text="module.failed"></td>
                            <td class="status-skipped" x-text="module.skipped"></td>
                            <td>
                                <span :class="getPassRateClass(module.pass_rate)"
                                      x-text="module.pass_rate.toFixed(2) + '%'">
                                </span>
                            </td>
                            <td>
                                <a :href="`/trends/${selectedRelease}/${module.module_name}`"
                                   class="btn-small">
                                    View Trends
                                </a>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>

        <!-- Recent Test Runs Table (All Modules view only) -->
        <div class="runs-section" x-show="selectedModule === '__all__' && recentJobs.length > 0">
            <div class="section-header">
                <h3>Recent Test Runs</h3>
            </div>
            <table class="runs-table">
                <thead>
                    <tr>
                        <th>Run ID</th>
                        <th>Version</th>
                        <th>Modules</th>
                        <th>Total Tests</th>
                        <th>Passed</th>
                        <th>Failed</th>
                        <th>Skipped</th>
                        <th>Pass Rate</th>
                        <th>Created</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="run in recentJobs" :key="run.parent_job_id || run.job_id">
                        <tr>
                            <td x-text="run.parent_job_id || run.job_id"></td>
                            <td x-text="run.version || 'N/A'"></td>
                            <td x-text="run.module_count || 1"></td>
                            <td x-text="run.total"></td>
                            <td class="status-passed" x-text="run.passed"></td>
                            <td class="status-failed" x-text="run.failed"></td>
                            <td class="status-skipped" x-text="run.skipped"></td>
                            <td>
                                <span :class="getPassRateClass(run.pass_rate)"
                                      x-text="run.pass_rate.toFixed(2) + '%'">
                                </span>
                            </td>
                            <td x-text="formatDate(run.created_at)"></td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>

        <!-- Empty State -->
        <div x-show="!recentJobs.length && !loading" class="empty-state">
            <p>No jobs found for this module.</p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/dashboard.js"></script>
{% endblock %}
