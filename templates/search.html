{% extends "base.html" %}

{% block title %}Test Case Search - Regression Tracker{% endblock %}

{% block content %}
<div x-data="searchData()" x-init="init()" x-cloak class="search-container">
    <!-- Header -->
    <div class="search-header">
        <h2>Test Case Search</h2>
        <p class="subtitle">Search by test case ID, TestRail ID, or test name</p>
    </div>

    <!-- Search Input -->
    <div class="search-input-section">
        <div class="search-input-wrapper" style="position: relative;">
            <input
                type="text"
                x-model="searchQuery"
                @input="onSearchInput()"
                @keydown="handleKeydown($event)"
                @blur="hideSuggestions()"
                @keyup.enter="performSearch()"
                placeholder="Enter test_case_id (TC-1234), testrail_id (C12345), or test name..."
                class="search-input"
                autocomplete="off"
                autofocus>
            <button
                @click="performSearch()"
                :disabled="!searchQuery.trim() || loading"
                class="btn-primary search-button">
                <span x-show="!loading">Search</span>
                <span x-show="loading">Searching...</span>
            </button>

            <!-- Autocomplete Dropdown -->
            <div
                x-show="showSuggestions"
                class="autocomplete-dropdown"
                style="position: absolute; top: 100%; left: 0; right: 80px; z-index: 1000; background: white; border: 1px solid #ddd; border-radius: 4px; margin-top: 4px; max-height: 400px; overflow-y: auto; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                <template x-for="(suggestion, index) in suggestions" :key="suggestion.testcase_name">
                    <div
                        @click="selectSuggestion(suggestion)"
                        :class="{'selected': index === selectedSuggestionIndex}"
                        class="autocomplete-item"
                        style="padding: 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0;">
                        <div style="font-weight: 500; color: #333; margin-bottom: 4px;" x-text="suggestion.testcase_name"></div>
                        <div style="font-size: 0.875rem; color: #666;">
                            <span x-text="suggestion.test_case_id"></span>
                            <span style="margin-left: 8px;">·</span>
                            <span
                                :class="getPriorityBadgeClass(suggestion.priority)"
                                style="margin-left: 8px;"
                                x-text="suggestion.priority">
                            </span>
                        </div>
                    </div>
                </template>
            </div>
        </div>
        <div x-show="searchQuery.trim()" class="search-hint">
            Press Enter or click Search to find test cases
        </div>
    </div>

    <!-- Loading State -->
    <div x-show="loading" class="loading-spinner" role="status" aria-live="polite">
        <p>Searching...</p>
    </div>

    <!-- Error State -->
    <div x-show="error" x-text="error" class="error-message" role="alert" aria-live="assertive"></div>

    <!-- Search Results -->
    <div x-show="!loading && !error && results.length > 0">
        <div class="results-header">
            <h3>Search Results (<span x-text="results.length"></span>)</h3>
        </div>

        <div class="results-table-container">
            <table class="search-results-table">
                <thead>
                    <tr>
                        <th>Test Name</th>
                        <th>Test Case ID</th>
                        <th>TestRail ID</th>
                        <th>Priority</th>
                        <th>Component</th>
                        <th>Automation Status</th>
                        <th>Total Executions</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="result in results" :key="result.testcase_name">
                        <tr>
                            <td class="test-name-cell">
                                <div class="test-name" x-text="result.testcase_name"></div>
                                <small x-show="hasMultipleVariants(result)" style="color: #666;">
                                    (<span x-text="result.metadata_variants.length"></span> variants)
                                </small>
                            </td>
                            <td x-text="getFirstVariant(result, 'test_case_id') || 'N/A'"></td>
                            <td x-text="getFirstVariant(result, 'testrail_id') || 'N/A'"></td>
                            <td class="priority-cell">
                                <span :class="getPriorityBadgeClass(getFirstVariant(result, 'priority'))"
                                      x-text="getFirstVariant(result, 'priority') || 'Unknown'">
                                </span>
                            </td>
                            <td x-text="getFirstVariant(result, 'component') || 'N/A'"></td>
                            <td>
                                <span :class="getAutomationStatusClass(getFirstVariant(result, 'automation_status'))"
                                      x-text="getFirstVariant(result, 'automation_status') || 'N/A'">
                                </span>
                            </td>
                            <td x-text="result.total_executions || 0"></td>
                            <td>
                                <button
                                    @click="viewDetails(result.testcase_name)"
                                    class="btn-small">
                                    View History
                                </button>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Empty State -->
    <div x-show="!loading && !error && searchPerformed && results.length === 0" class="empty-state">
        <p>No test cases found matching "<span x-text="searchQuery"></span>"</p>
        <p class="empty-state-hint">Try searching by:</p>
        <ul class="empty-state-list">
            <li>Test Case ID (e.g., TC-1234)</li>
            <li>TestRail ID (e.g., C12345)</li>
            <li>Test name (partial match supported)</li>
        </ul>
    </div>

    <!-- Details Modal -->
    <div x-show="showDetails"
         @click="closeDetails()"
         class="modal-overlay"
         role="dialog"
         aria-modal="true"
         aria-labelledby="modal-title">
        <div class="modal-content" @click.stop>
            <!-- Modal Header -->
            <div class="modal-header">
                <h3 id="modal-title">Execution History</h3>
                <button @click="closeDetails()"
                        class="modal-close"
                        aria-label="Close modal">&times;</button>
            </div>

            <!-- Test Details -->
            <div x-show="detailsData" class="modal-body">
                <div class="test-metadata">
                    <div class="metadata-row">
                        <span class="metadata-label">Test Name:</span>
                        <span class="metadata-value" x-text="detailsData?.testcase_name"></span>
                    </div>

                    <!-- Collapsible Metadata Section Header -->
                    <div style="margin-top: 20px;">
                        <div
                            @click="metadataExpanded = !metadataExpanded"
                            style="cursor: pointer; padding: 10px; background: #f8f9fa; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; user-select: none;"
                            :style="metadataExpanded ? 'border-bottom-left-radius: 0; border-bottom-right-radius: 0;' : ''"
                        >
                            <h4 style="margin: 0; font-size: 1em; font-weight: 600;">
                                Test Metadata
                                <span x-show="detailsData?.metadata_variants && detailsData.metadata_variants.length > 1" style="color: #666; font-weight: normal; font-size: 0.9em;">
                                    (varies by release)
                                </span>
                            </h4>
                            <span x-text="metadataExpanded ? '▼' : '▶'" style="color: #666; font-size: 0.9em;"></span>
                        </div>

                        <!-- Metadata Variants with Release Tabs -->
                        <div x-show="metadataExpanded && detailsData?.metadata_variants && detailsData.metadata_variants.length > 0" x-collapse class="metadata-variants-section" style="border: 1px solid #dee2e6; border-top: none; border-radius: 0 0 4px 4px; padding: 12px;">

                        <!-- Release Tabs -->
                        <div class="release-tabs" style="display: flex; gap: 4px; margin-bottom: 16px; border-bottom: 2px solid #e0e0e0;">
                            <template x-for="(variant, index) in detailsData?.metadata_variants || []" :key="variant.release">
                                <button
                                    @click="selectedReleaseTab = variant.release"
                                    :class="{'active': selectedReleaseTab === variant.release}"
                                    class="release-tab"
                                    style="padding: 8px 16px; border: none; background: transparent; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 500; color: #666; transition: all 0.2s;"
                                    :style="selectedReleaseTab === variant.release ? 'border-bottom-color: #007bff; color: #007bff;' : ''"
                                    x-text="variant.release">
                                </button>
                            </template>
                        </div>

                        <!-- Metadata Content for Selected Release -->
                        <template x-for="variant in detailsData?.metadata_variants || []" :key="variant.release + '-content'">
                            <div x-show="selectedReleaseTab === variant.release" class="metadata-content">
                                <div class="metadata-row">
                                    <span class="metadata-label">Test Case ID:</span>
                                    <span class="metadata-value" x-text="variant.test_case_id || 'N/A'"></span>
                                </div>
                                <div class="metadata-row">
                                    <span class="metadata-label">TestRail ID:</span>
                                    <span class="metadata-value" x-text="variant.testrail_id || 'N/A'"></span>
                                </div>
                                <div class="metadata-row">
                                    <span class="metadata-label">Priority:</span>
                                    <span :class="getPriorityBadgeClass(variant.priority)"
                                          x-text="variant.priority || 'Unknown'">
                                    </span>
                                    <span x-show="hasMetadataVariation('priority', variant.release)"
                                          class="variation-indicator"
                                          style="margin-left: 8px; color: #ff9800; font-size: 1.2em;"
                                          title="Priority differs from Global">
                                        ⚠️
                                    </span>
                                </div>
                                <div class="metadata-row">
                                    <span class="metadata-label">Topology:</span>
                                    <span class="metadata-value" x-text="variant.topology || 'N/A'"></span>
                                    <span x-show="hasMetadataVariation('topology', variant.release)"
                                          class="variation-indicator"
                                          style="margin-left: 8px; color: #ff9800; font-size: 1.2em;"
                                          title="Topology differs from Global">
                                        ⚠️
                                    </span>
                                </div>
                                <div class="metadata-row">
                                    <span class="metadata-label">Test State:</span>
                                    <span class="metadata-value" x-text="variant.test_state || 'N/A'"></span>
                                    <span x-show="hasMetadataVariation('test_state', variant.release)"
                                          class="variation-indicator"
                                          style="margin-left: 8px; color: #ff9800; font-size: 1.2em;"
                                          title="Test State differs from Global">
                                        ⚠️
                                    </span>
                                </div>
                                <div class="metadata-row">
                                    <span class="metadata-label">Module:</span>
                                    <span class="metadata-value" x-text="variant.module || 'N/A'"></span>
                                </div>
                                <div class="metadata-row">
                                    <span class="metadata-label">Component:</span>
                                    <span class="metadata-value" x-text="variant.component || 'N/A'"></span>
                                </div>
                                <div class="metadata-row">
                                    <span class="metadata-label">Class Name:</span>
                                    <span class="metadata-value" x-text="variant.test_class_name || 'N/A'"></span>
                                </div>
                                <div class="metadata-row">
                                    <span class="metadata-label">Test Path:</span>
                                    <span class="metadata-value" x-text="variant.test_path || 'N/A'"></span>
                                </div>
                                <div class="metadata-row">
                                    <span class="metadata-label">Removed:</span>
                                    <span :class="variant.is_removed ? 'status-failed' : 'status-passed'"
                                          style="font-weight: 600;"
                                          x-text="variant.is_removed ? 'Yes' : 'No'">
                                    </span>
                                </div>
                            </div>
                        </template>
                        </div>

                        <!-- Fallback for old data without metadata_variants -->
                        <div x-show="metadataExpanded && (!detailsData?.metadata_variants || detailsData.metadata_variants.length === 0)" x-collapse style="border: 1px solid #dee2e6; border-top: none; border-radius: 0 0 4px 4px; padding: 12px; background: #f8f9fa; border-left: 3px solid #ffc107;">
                            <p style="margin: 0; color: #856404;">No metadata available for this test case</p>
                        </div>
                    </div>
                </div>

                <!-- Statistics -->
                <div x-show="detailsData?.statistics" class="statistics-section">
                    <h4>Statistics</h4>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <span class="stat-label">Total Runs:</span>
                            <span class="stat-value" x-text="detailsData?.statistics?.total_runs || 0"></span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Passed:</span>
                            <span class="stat-value status-passed" x-text="detailsData?.statistics?.passed || 0"></span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Failed:</span>
                            <span class="stat-value status-failed" x-text="detailsData?.statistics?.failed || 0"></span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Pass Rate:</span>
                            <span class="stat-value" x-text="(detailsData?.statistics?.pass_rate || 0) + '%'"></span>
                        </div>
                    </div>
                </div>

                <!-- Execution History -->
                <div x-show="detailsData?.execution_history" class="execution-history-section">
                    <h4>Recent Executions</h4>
                    <div class="execution-history-table-wrapper">
                        <table class="execution-history-table">
                            <thead>
                                <tr>
                                    <th>Job ID</th>
                                    <th>Release</th>
                                    <th>Module</th>
                                    <th>Version</th>
                                    <th>Status</th>
                                    <th title="Execution topology from JUnit XML (what Jenkins ran)">Jenkins Topology</th>
                                    <th title="Design topology from metadata CSV (test specification)">Design Topology</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="history in detailsData?.execution_history || []" :key="history.job_id + history.created_at">
                                    <tr>
                                        <td x-text="history.job_id"></td>
                                        <td x-text="history.release"></td>
                                        <td x-text="history.module"></td>
                                        <td x-text="history.version || 'N/A'"></td>
                                        <td>
                                            <span :class="getStatusClass(history.status)"
                                                  x-text="history.status">
                                            </span>
                                            <span x-show="history.was_rerun" class="rerun-badge">Rerun</span>
                                        </td>
                                        <td x-text="history.jenkins_topology || 'N/A'"></td>
                                        <td x-text="history.topology_metadata || 'N/A'"></td>
                                        <td x-text="formatDate(history.created_at)"></td>
                                        <td>
                                            <a :href="`/jobs/${history.release}/${history.module}/${history.job_id}?test=${encodeURIComponent(currentTestcaseName)}`"
                                               class="btn-small"
                                               target="_blank">
                                                View Job
                                            </a>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div x-show="detailsData?.pagination" class="pagination">
                        <button
                            @click="loadPreviousPage()"
                            :disabled="!hasPreviousPage()"
                            class="btn-pagination">
                            Previous
                        </button>
                        <span class="pagination-info">
                            Showing <span x-text="getPaginationStart()"></span> to <span x-text="getPaginationEnd()"></span>
                            of <span x-text="detailsData?.pagination?.total || 0"></span>
                        </span>
                        <button
                            @click="loadNextPage()"
                            :disabled="!hasNextPage()"
                            class="btn-pagination">
                            Next
                        </button>
                    </div>
                </div>
            </div>

            <!-- Loading State in Modal -->
            <div x-show="detailsLoading" class="loading-spinner" role="status" aria-live="polite">
                <p>Loading execution history...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/search.js"></script>
{% endblock %}
