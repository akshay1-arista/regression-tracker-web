{% extends "base.html" %}

{% block title %}Job {{ job_id }} - {{ release }}/{{ module }}{% endblock %}

{% block extra_head %}
<!-- Load job_details.js synchronously before Alpine.js -->
<script type="text/javascript" src="/static/js/job_details.js?v={{ range(1, 10000) | random }}"></script>
{% endblock %}

{% block content %}
<div x-data="jobDetailsData('{{ release }}', '{{ module }}', '{{ job_id }}')" x-init="init()" class="job-details-container">
    <!-- Header -->
    <div class="job-header">
        <div class="breadcrumb">
            <a href="/">Dashboard</a> /
            <a :href="`/trends/${release}/${module}`" x-text="`${release}/${module}`"></a> /
            <span x-text="`Job ${job_id}`"></span>
        </div>
        <h2>Job <span x-text="job_id"></span></h2>
        <p class="subtitle" x-show="job">
            Created: <span x-text="formatDate(job?.created_at)"></span>
        </p>
    </div>

    <!-- Loading State -->
    <div x-show="loading" class="loading-spinner">
        <span class="spinner"></span>
        <span>Loading job details...</span>
    </div>

    <!-- Error State -->
    <div x-show="error" x-text="error" class="error-message"></div>

    <!-- Job Details Content -->
    <div x-show="!loading && !error">
        <!-- Summary Cards -->
        <div class="summary-cards" x-show="job">
            <div class="card">
                <h3>Total Tests</h3>
                <div class="stat-value" x-text="job?.total || 0"></div>
            </div>

            <div class="card">
                <h3>Passed</h3>
                <div class="stat-value status-passed" x-text="job?.passed || 0"></div>
                <div class="stat-label" x-text="`${getPercentage(job?.passed, job?.total)}%`"></div>
            </div>

            <div class="card">
                <h3>Failed</h3>
                <div class="stat-value status-failed" x-text="job?.failed || 0"></div>
                <div class="stat-label" x-text="`${getPercentage(job?.failed, job?.total)}%`"></div>
            </div>

            <div class="card">
                <h3>Skipped</h3>
                <div class="stat-value status-skipped" x-text="job?.skipped || 0"></div>
                <div class="stat-label" x-text="`${getPercentage(job?.skipped, job?.total)}%`"></div>
            </div>

            <div class="card">
                <h3>Pass Rate</h3>
                <div class="stat-value"
                     :class="getPassRateClass(job?.pass_rate)"
                     x-text="(job?.pass_rate || 0) + '%'">
                </div>
            </div>
        </div>

        <!-- Jenkins Link -->
        <div class="jenkins-link" x-show="job?.jenkins_url">
            <a :href="job?.jenkins_url" target="_blank" class="btn-secondary">
                View on Jenkins →
            </a>
        </div>

        <!-- Filters -->
        <div class="filters-section">
            <h3>Filter Tests</h3>
            <div class="filter-controls">
                <!-- Status Filters -->
                <div class="filter-section">
                    <label class="filter-label">Status:</label>
                    <div class="filter-chips" role="group" aria-label="Filter by status">
                        <button
                            @click="toggleStatus('PASSED')"
                            :class="{'active': filters.statuses.includes('PASSED')}"
                            :aria-pressed="filters.statuses.includes('PASSED').toString()"
                            aria-label="Filter by passed status"
                            class="filter-chip status-chip">
                            Passed <span x-show="filters.statuses.includes('PASSED')" aria-hidden="true">✓</span>
                        </button>
                        <button
                            @click="toggleStatus('FAILED')"
                            :class="{'active': filters.statuses.includes('FAILED')}"
                            :aria-pressed="filters.statuses.includes('FAILED').toString()"
                            aria-label="Filter by failed status"
                            class="filter-chip status-chip">
                            Failed <span x-show="filters.statuses.includes('FAILED')" aria-hidden="true">✓</span>
                        </button>
                        <button
                            @click="toggleStatus('SKIPPED')"
                            :class="{'active': filters.statuses.includes('SKIPPED')}"
                            :aria-pressed="filters.statuses.includes('SKIPPED').toString()"
                            aria-label="Filter by skipped status"
                            class="filter-chip status-chip">
                            Skipped <span x-show="filters.statuses.includes('SKIPPED')" aria-hidden="true">✓</span>
                        </button>
                    </div>
                </div>

                <!-- Priority Filters -->
                <div class="filter-section">
                    <label class="filter-label">Priority:</label>
                    <div class="filter-chips priority-chips" role="group" aria-label="Filter by priority">
                        <button
                            @click="togglePriority('P0')"
                            :class="{'active': filters.priorities.includes('P0')}"
                            :aria-pressed="filters.priorities.includes('P0').toString()"
                            aria-label="Filter by P0 priority"
                            class="filter-chip priority-chip">
                            P0 <span x-show="filters.priorities.includes('P0')" aria-hidden="true">✓</span>
                        </button>
                        <button
                            @click="togglePriority('P1')"
                            :class="{'active': filters.priorities.includes('P1')}"
                            :aria-pressed="filters.priorities.includes('P1').toString()"
                            aria-label="Filter by P1 priority"
                            class="filter-chip priority-chip">
                            P1 <span x-show="filters.priorities.includes('P1')" aria-hidden="true">✓</span>
                        </button>
                        <button
                            @click="togglePriority('P2')"
                            :class="{'active': filters.priorities.includes('P2')}"
                            :aria-pressed="filters.priorities.includes('P2').toString()"
                            aria-label="Filter by P2 priority"
                            class="filter-chip priority-chip">
                            P2 <span x-show="filters.priorities.includes('P2')" aria-hidden="true">✓</span>
                        </button>
                        <button
                            @click="togglePriority('P3')"
                            :class="{'active': filters.priorities.includes('P3')}"
                            :aria-pressed="filters.priorities.includes('P3').toString()"
                            aria-label="Filter by P3 priority"
                            class="filter-chip priority-chip">
                            P3 <span x-show="filters.priorities.includes('P3')" aria-hidden="true">✓</span>
                        </button>
                        <button
                            @click="togglePriority('UNKNOWN')"
                            :class="{'active': filters.priorities.includes('UNKNOWN')}"
                            :aria-pressed="filters.priorities.includes('UNKNOWN').toString()"
                            aria-label="Filter by unknown priority"
                            class="filter-chip priority-chip">
                            Unknown <span x-show="filters.priorities.includes('UNKNOWN')" aria-hidden="true">✓</span>
                        </button>
                    </div>
                </div>

                <!-- Design Topology Filter -->
                <div class="filter-group">
                    <label for="topology-filter" title="Filter by design topology from metadata CSV. Note: Grouped view groups by execution topology (Jenkins), not design topology.">Design Topology:</label>
                    <select
                        id="topology-filter"
                        x-model="filters.topology"
                        @change="loadTests()"
                        class="filter-select">
                        <option value="">All</option>
                        <template x-for="topology in topologies" :key="topology">
                            <option :value="topology" x-text="topology"></option>
                        </template>
                    </select>
                </div>

                <!-- Search -->
                <div class="filter-group">
                    <label for="search-input">Search:</label>
                    <input
                        id="search-input"
                        type="text"
                        x-model="filters.search"
                        @input.debounce.500ms="loadTests()"
                        placeholder="Test name, class, or file..."
                        class="filter-input">
                </div>

                <!-- Clear Filters -->
                <button
                    @click="clearFilters()"
                    x-show="hasActiveFilters()"
                    class="btn-small clear">
                    Clear Filters
                </button>
            </div>
            <div class="filter-stats">
                <span x-text="`Showing ${metadata?.total || 0} tests`"></span>
                <span style="margin-left: 1rem; color: #666; font-size: 0.875rem;">
                    (View: <span x-text="viewMode"></span>,
                    Topologies: <span x-text="Object.keys(groupedTests).length"></span>,
                    Has data: <span x-text="hasGroupedTests()"></span>)
                </span>
            </div>
        </div>

        <!-- Grouped View (by Topology and Setup IP) -->
        <!-- NOTE: Groups tests by EXECUTION topology (from Jenkins), but filter uses DESIGN topology (from metadata) -->
        <div class="grouped-tests-container" x-show="viewMode === 'grouped' && hasGroupedTests()">
            <template x-for="topology in getSortedTopologies()" :key="topology">
                <div class="topology-group">
                    <h3 class="topology-header" title="Execution topology from Jenkins (groups tests by what Jenkins ran)">
                        <span style="font-weight: normal; font-size: 0.9em; color: #666;">Execution Topology (Jenkins):</span>
                        <span x-text="topology"></span>
                    </h3>

                    <template x-for="setupIp in getSortedSetupIps(topology)" :key="`${topology}-${setupIp}`">
                        <div class="setup-ip-group">
                            <div class="setup-ip-header" @click="toggleGroup(`${topology}-${setupIp}`)">
                                <span class="toggle-icon" x-text="isGroupExpanded(`${topology}-${setupIp}`) ? '▼' : '▶'"></span>
                                <strong x-text="`Setup IP: ${setupIp}`"></strong>
                                <template x-data="{ stats: getGroupStats(getTestsForGroup(topology, setupIp)) }">
                                    <span class="group-stats">
                                        (<span x-text="stats.total"></span> tests:
                                        <span class="status-passed" x-text="`${stats.passed} passed`"></span>,
                                        <span class="status-failed" x-text="`${stats.failed} failed`"></span>,
                                        <span class="status-skipped" x-text="`${stats.skipped} skipped`"></span>,
                                        <span class="status-error" x-text="`${stats.error} error`"></span>)
                                    </span>
                                </template>
                            </div>

                            <div x-show="isGroupExpanded(`${topology}-${setupIp}`)" class="group-tests">
                                <table class="tests-table">
                                    <thead>
                                        <tr>
                                            <th>Test Name</th>
                                            <th>Priority</th>
                                            <th title="Design topology from metadata CSV (test specification)">Design Topology</th>
                                            <th>Class</th>
                                            <th>Status</th>
                                            <th>Bugs</th>
                                            <th>Rerun</th>
                                            <th>Details</th>
                                        </tr>
                                    </thead>
                                    <template x-for="test in getTestsForGroup(topology, setupIp)" :key="test.test_key">
                                        <tbody>
                                            <tr>
                                                <td class="test-name-cell">
                                                    <a href="#" @click.prevent="viewDetails(test.test_name)" class="test-name-link" x-text="test.test_name"></a>
                                                </td>
                                                <td class="priority-cell">
                                                    <span :class="getPriorityBadgeClass(test.priority)"
                                                          x-text="getPriorityDisplayText(test.priority)">
                                                    </span>
                                                </td>
                                                <td x-text="test.topology_metadata || 'N/A'"></td>
                                                <td class="class-name-cell" x-text="test.class_name"></td>
                                                <td>
                                                    <span :class="getStatusClass(test.status)"
                                                          x-text="test.status">
                                                    </span>
                                                </td>
                                                <td class="bugs-cell">
                                                    <template x-if="test.bugs && test.bugs.length > 0">
                                                        <div class="bug-badges">
                                                            <!-- Show only first bug when collapsed -->
                                                            <template x-if="!expandedBugs.includes(test.test_key)">
                                                                <a :href="test.bugs[0].url"
                                                                   target="_blank"
                                                                   class="bug-badge"
                                                                   :class="getBugBadgeClass(test.bugs[0])"
                                                                   :title="getBugTooltipText(test.bugs[0])">
                                                                    <span x-text="test.bugs[0].defect_id"></span>
                                                                </a>
                                                            </template>
                                                            <!-- Show all bugs when expanded -->
                                                            <template x-if="expandedBugs.includes(test.test_key)">
                                                                <template x-for="bug in test.bugs" :key="bug.defect_id">
                                                                    <a :href="bug.url"
                                                                       target="_blank"
                                                                       class="bug-badge"
                                                                       :class="getBugBadgeClass(bug)"
                                                                       :title="getBugTooltipText(bug)">
                                                                        <span x-text="bug.defect_id"></span>
                                                                    </a>
                                                                </template>
                                                            </template>
                                                            <!-- Toggle button for multiple bugs -->
                                                            <template x-if="test.bugs.length > 1">
                                                                <span class="bug-count-badge"
                                                                      @click="toggleBugs(test.test_key)"
                                                                      :title="expandedBugs.includes(test.test_key) ? 'Hide bugs' : 'Show all bugs'"
                                                                      x-text="expandedBugs.includes(test.test_key) ? 'Hide ▲' : `+${test.bugs.length - 1} more ▼`">
                                                                </span>
                                                            </template>
                                                        </div>
                                                    </template>
                                                    <template x-if="!test.bugs || test.bugs.length === 0">
                                                        <span class="text-muted">—</span>
                                                    </template>
                                                </td>
                                                <td>
                                                    <span x-show="test.was_rerun" class="badge badge-rerun">
                                                        Rerun
                                                        <span x-show="test.rerun_still_failed" class="badge-failed">Still Failed</span>
                                                    </span>
                                                </td>
                                                <td>
                                                    <button
                                                        x-show="test.failure_message"
                                                        class="failure-message-toggle"
                                                        role="button"
                                                        :aria-expanded="expandedTests.includes(test.test_key).toString()"
                                                        :aria-label="expandedTests.includes(test.test_key) ? 'Hide error message for ' + test.test_name : 'Show error message for ' + test.test_name"
                                                        @click="toggleTestError(test.test_key)"
                                                        x-text="expandedTests.includes(test.test_key) ? 'Hide Error ▲' : 'Show Error ▼'">
                                                    </button>
                                                </td>
                                            </tr>
                                            <!-- Failure Message Row -->
                                            <tr class="failure-message-row" :class="{ 'expanded': expandedTests.includes(test.test_key) }">
                                                <td colspan="6" class="failure-message-cell">
                                                    <div class="failure-message-content" x-text="test.failure_message"></div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </template>
                                </table>
                            </div>
                        </div>
                    </template>
                </div>
            </template>
        </div>

        <!-- Flat View (with filters/pagination) -->
        <div class="tests-table-container" x-show="viewMode === 'flat' && tests.length > 0">
            <table class="tests-table">
                <thead>
                    <tr>
                        <th>Test Name</th>
                        <th>Priority</th>
                        <th>Class</th>
                        <th>Status</th>
                        <th>Bugs</th>
                        <th title="Execution topology from JUnit XML (what Jenkins ran)">Jenkins Topology</th>
                        <th title="Design topology from metadata CSV (test specification)">Design Topology</th>
                        <th>Setup IP</th>
                        <th>Rerun</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <template x-for="test in tests" :key="test.test_key">
                    <tbody>
                        <tr>
                            <td class="test-name-cell">
                                <a href="#" @click.prevent="viewDetails(test.test_name)" class="test-name-link" x-text="test.test_name"></a>
                            </td>
                            <td class="priority-cell">
                                <span :class="getPriorityBadgeClass(test.priority)"
                                      x-text="getPriorityDisplayText(test.priority)">
                                </span>
                            </td>
                            <td class="class-name-cell" x-text="test.class_name"></td>
                            <td>
                                <span :class="getStatusClass(test.status)"
                                      x-text="test.status">
                                </span>
                            </td>
                            <td class="bugs-cell">
                                <template x-if="test.bugs && test.bugs.length > 0">
                                    <div class="bug-badges">
                                        <!-- Show only first bug when collapsed -->
                                        <template x-if="!expandedBugs.includes(test.test_key)">
                                            <a :href="test.bugs[0].url"
                                               target="_blank"
                                               class="bug-badge"
                                               :class="getBugBadgeClass(test.bugs[0])"
                                               :title="getBugTooltipText(test.bugs[0])">
                                                <span x-text="test.bugs[0].defect_id"></span>
                                            </a>
                                        </template>
                                        <!-- Show all bugs when expanded -->
                                        <template x-if="expandedBugs.includes(test.test_key)">
                                            <template x-for="bug in test.bugs" :key="bug.defect_id">
                                                <a :href="bug.url"
                                                   target="_blank"
                                                   class="bug-badge"
                                                   :class="getBugBadgeClass(bug)"
                                                   :title="getBugTooltipText(bug)">
                                                    <span x-text="bug.defect_id"></span>
                                                </a>
                                            </template>
                                        </template>
                                        <!-- Toggle button for multiple bugs -->
                                        <template x-if="test.bugs.length > 1">
                                            <span class="bug-count-badge"
                                                  @click="toggleBugs(test.test_key)"
                                                  :title="expandedBugs.includes(test.test_key) ? 'Hide bugs' : 'Show all bugs'"
                                                  x-text="expandedBugs.includes(test.test_key) ? 'Hide ▲' : `+${test.bugs.length - 1} more ▼`">
                                            </span>
                                        </template>
                                    </div>
                                </template>
                                <template x-if="!test.bugs || test.bugs.length === 0">
                                    <span class="text-muted">—</span>
                                </template>
                            </td>
                            <td x-text="test.jenkins_topology || 'N/A'"></td>
                            <td x-text="test.topology_metadata || 'N/A'"></td>
                            <td x-text="test.setup_ip || 'N/A'"></td>
                            <td>
                                <span x-show="test.was_rerun" class="badge badge-rerun">
                                    Rerun
                                    <span x-show="test.rerun_still_failed" class="badge-failed">Still Failed</span>
                                </span>
                            </td>
                            <td>
                                <button
                                    x-show="test.failure_message"
                                    class="failure-message-toggle"
                                    role="button"
                                    :aria-expanded="expandedTests.includes(test.test_key).toString()"
                                    :aria-label="expandedTests.includes(test.test_key) ? 'Hide error message for ' + test.test_name : 'Show error message for ' + test.test_name"
                                    @click="toggleTestError(test.test_key)"
                                    x-text="expandedTests.includes(test.test_key) ? 'Hide Error ▲' : 'Show Error ▼'">
                                </button>
                            </td>
                        </tr>
                        <!-- Failure Message Row (hidden by default, shown via CSS class) -->
                        <tr class="failure-message-row" :class="{ 'expanded': expandedTests.includes(test.test_key) }">
                            <td colspan="8" class="failure-message-cell">
                                <div class="failure-message-content" x-text="test.failure_message"></div>
                            </td>
                        </tr>
                    </tbody>
                </template>
            </table>

            <!-- Pagination -->
            <div class="pagination" x-show="metadata?.total > 100">
                <button
                    @click="previousPage()"
                    :disabled="!metadata?.has_previous"
                    class="btn-pagination">
                    Previous
                </button>
                <span class="pagination-info">
                    Page <span x-text="getCurrentPage()"></span> of <span x-text="getTotalPages()"></span>
                </span>
                <button
                    @click="nextPage()"
                    :disabled="!metadata?.has_next"
                    class="btn-pagination">
                    Next
                </button>
            </div>
        </div>

        <!-- Empty State -->
        <div x-show="(viewMode === 'flat' && !tests.length && !loading) || (viewMode === 'grouped' && !hasGroupedTests() && !loading)" class="empty-state">
            <p>No tests found matching the current filters.</p>
        </div>
    </div>

    <!-- Execution History Modal -->
    <div x-show="showDetails"
         @click="closeDetails()"
         class="modal-overlay"
         role="dialog"
         aria-modal="true"
         aria-labelledby="modal-title">
        <div class="modal-content" @click.stop>
            <!-- Modal Header -->
            <div class="modal-header">
                <h3 id="modal-title">Execution History</h3>
                <button @click="closeDetails()"
                        class="modal-close"
                        aria-label="Close modal">&times;</button>
            </div>

            <!-- Test Details -->
            <div x-show="detailsData" class="modal-body">
                <div class="test-metadata">
                    <div class="metadata-row">
                        <span class="metadata-label">Test Name:</span>
                        <span class="metadata-value" x-text="detailsData?.testcase_name"></span>
                    </div>
                    <div class="metadata-row">
                        <span class="metadata-label">Test Case ID:</span>
                        <span class="metadata-value" x-text="detailsData?.test_case_id || 'N/A'"></span>
                    </div>
                    <div class="metadata-row">
                        <span class="metadata-label">TestRail ID:</span>
                        <span class="metadata-value" x-text="detailsData?.testrail_id || 'N/A'"></span>
                    </div>
                    <div class="metadata-row">
                        <span class="metadata-label">Priority:</span>
                        <span :class="getPriorityBadgeClass(detailsData?.priority)"
                              x-text="detailsData?.priority || 'Unknown'">
                        </span>
                    </div>
                    <div class="metadata-row">
                        <span class="metadata-label">Component:</span>
                        <span class="metadata-value" x-text="detailsData?.component || 'N/A'"></span>
                    </div>
                    <div class="metadata-row">
                        <span class="metadata-label">Class Name:</span>
                        <span class="metadata-value" x-text="detailsData?.test_class_name || 'N/A'"></span>
                    </div>
                    <div class="metadata-row">
                        <span class="metadata-label">Test Path:</span>
                        <span class="metadata-value" x-text="detailsData?.test_path || 'N/A'"></span>
                    </div>
                    <div class="metadata-row">
                        <span class="metadata-label">Test State:</span>
                        <span class="metadata-value" x-text="detailsData?.test_state || 'N/A'"></span>
                    </div>
                </div>

                <!-- Statistics -->
                <div x-show="detailsData?.statistics" class="statistics-section">
                    <h4>Statistics</h4>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <span class="stat-label">Total Runs:</span>
                            <span class="stat-value" x-text="detailsData?.statistics?.total_runs || 0"></span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Passed:</span>
                            <span class="stat-value status-passed" x-text="detailsData?.statistics?.passed || 0"></span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Failed:</span>
                            <span class="stat-value status-failed" x-text="detailsData?.statistics?.failed || 0"></span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Pass Rate:</span>
                            <span class="stat-value" x-text="(detailsData?.statistics?.pass_rate || 0) + '%'"></span>
                        </div>
                    </div>
                </div>

                <!-- Execution History -->
                <div x-show="detailsData?.execution_history" class="execution-history-section">
                    <h4>Recent Executions</h4>
                    <div class="execution-history-table-wrapper">
                        <table class="execution-history-table">
                            <thead>
                                <tr>
                                    <th>Job ID</th>
                                    <th>Release</th>
                                    <th>Module</th>
                                    <th>Version</th>
                                    <th>Status</th>
                                    <th title="Execution topology from JUnit XML (what Jenkins ran)">Jenkins Topology</th>
                                    <th title="Design topology from metadata CSV (test specification)">Design Topology</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="history in detailsData?.execution_history || []" :key="history.job_id + history.created_at">
                                    <tr>
                                        <td x-text="history.job_id"></td>
                                        <td x-text="history.release"></td>
                                        <td x-text="history.module"></td>
                                        <td x-text="history.version || 'N/A'"></td>
                                        <td>
                                            <span :class="getStatusClass(history.status)"
                                                  x-text="history.status">
                                            </span>
                                            <span x-show="history.was_rerun" class="rerun-badge">Rerun</span>
                                        </td>
                                        <td x-text="history.jenkins_topology || 'N/A'"></td>
                                        <td x-text="history.topology_metadata || 'N/A'"></td>
                                        <td x-text="formatDate(history.created_at)"></td>
                                        <td>
                                            <a :href="`/jobs/${history.release}/${history.module}/${history.job_id}?test=${encodeURIComponent(currentTestcaseName)}`"
                                               class="btn-small"
                                               target="_blank">
                                                View Job
                                            </a>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div x-show="detailsData?.pagination" class="pagination">
                        <button
                            @click="loadPreviousDetailsPage()"
                            :disabled="!hasPreviousDetailsPage()"
                            class="btn-pagination">
                            Previous
                        </button>
                        <span class="pagination-info">
                            Showing <span x-text="getDetailsPaginationStart()"></span> to <span x-text="getDetailsPaginationEnd()"></span>
                            of <span x-text="detailsData?.pagination?.total || 0"></span>
                        </span>
                        <button
                            @click="loadNextDetailsPage()"
                            :disabled="!hasNextDetailsPage()"
                            class="btn-pagination">
                            Next
                        </button>
                    </div>
                </div>
            </div>

            <!-- Loading State in Modal -->
            <div x-show="detailsLoading" class="loading-spinner" role="status" aria-live="polite">
                <p>Loading execution history...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}
